name: Deploy Backend to EC2 (Single-file, safe deploy)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Debug list repo (optional)
      run: |
        echo "PWD: $(pwd)"
        ls -la
        echo "backend tree (3 levels):"
        find backend -maxdepth 4 -print || true

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Publish Backend (Single-file)
      run: |
        echo "Publishing..."
        dotnet publish ./backend/src/WebAPI/WebAPI.csproj \
          -c Release \
          -o publish \
          -r linux-x64 \
          --self-contained true \
          /p:PublishSingleFile=true \
          /p:IncludeNativeLibrariesForSelfExtract=true \
          /p:PublishTrimmed=true \
          /p:TrimMode=Link \
          /p:DebugType=None \
          /p:DebugSymbols=false

        echo "Removing appsettings from publish folder..."
        rm -f publish/appsettings.json || true
        rm -f publish/appsettings.Development.json || true
        rm -f publish/appsettings.Production.json || true

        echo "Publish done. publish/ contents:"
        ls -la publish || true

    - name: Create tarball of publish contents (no containing folder)
      run: |
        cd publish
        # Tar contents only (NO appsettings.json)
        tar --exclude='appsettings*.json' -czf ../publish.tar.gz .
        cd ..
        echo "Created publish.tar.gz with size:"
        ls -lh publish.tar.gz

    - name: Upload tarball to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        source: "publish.tar.gz"
        target: "/home/ec2-user/"

    - name: Extract on EC2 into FinServeApi (overwrite only files) and cleanup
      uses: appleboy/ssh-action@v1.2.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          sudo mkdir -p /home/ec2-user/FinServeApi

          echo "Extracting publish.tar.gz..."
          sudo tar -xzf /home/ec2-user/publish.tar.gz -C /home/ec2-user/FinServeApi --overwrite

          echo "Preserving existing appsettings.json (not overwritten)."
          # Nothing required here because tar doesn't include appsettings.json

          sudo chmod +x /home/ec2-user/FinServeAPINew/WebAPI || true

          sudo rm -f /home/ec2-user/publish.tar.gz

          echo "Final deployment folder:"
          ls -la /home/ec2-user/FinServeAPINew | sed -n '1,200p'

    - name: Restart Backend service
      uses: appleboy/ssh-action@v1.2.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          sudo systemctl daemon-reload || true
          sudo systemctl restart finserve || true
          sudo systemctl status finserve --no-pager || true

    - name: Cleanup local publish tar
      run: |
        rm -f publish.tar.gz
